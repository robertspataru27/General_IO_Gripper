-- [Note] Only runs once and loads ALL variables
-- [Note] This file is Cached! Empty Cache and Reload after each edit during testing.

-- Init 
CS.UnityEngine.Debug.Log('ToolUI->Gripper Init triggered ')

local PTable = CS.ConfigurationMenu.ConfigurationMenuLuaInterface.Instance.parameterTable
local Instance = CS.ConfigurationMenu.ConfigurationMenuLuaInterface.Instance

function WriteToPTableForRobotCodeGen()
	local WaitValue = 0
	local WaitMask = 0
	local WaitStart = 0
	local WaitLength = 16

    -- Explicitly convert dropdown values to numbers to avoid string/integer confusion
    local DoCountSelection = tonumber(Instance:GetUiElementByName("DoCountSelection").value) or 0
    local CloseGripperDoSelection = Instance:GetUiElementByName("CloseGripperDoSelection").value
    local OpenGripperDoSelection = Instance:GetUiElementByName("OpenGripperDoSelection").value

    local DiCountSelection = tonumber(Instance:GetUiElementByName("DiCountSelection").value) or 0
    local FeedbackDISelection = Instance:GetUiElementByName("FeedbackDiSelection").value

    local Robot_DI_Done_Timeout_UI = tonumber(Instance:GetUiElementByName("TimeoutValue").value) or 0
    local Robot_DetectionDelay_UI = tonumber(Instance:GetUiElementByName("DetectionDelay").value) or 0
    local NotEqual_UI = Instance:GetUiElementByName("NotEqual").value

	for i = 0, DoCountSelection do
        local closeSlot = CloseGripperDoSelection[i]
        local openSlot = OpenGripperDoSelection[i]
        local closeNum = 0
        local closeVal = 0
        local openNum = 0
        local openVal = 0

        if closeSlot then
            closeNum = tonumber(closeSlot[0].value) or 0
            closeVal = tonumber(closeSlot[1].value) or 0
        end
        
        if openSlot then
            openNum = tonumber(openSlot[0].value) or 0
            openVal = tonumber(openSlot[1].value) or 0
        end
		
		PTable:set_Item("Robot_DO_Close" .. i .. "_N_UI", closeNum);
		PTable:set_Item("Robot_DO_Close" .. i .. "_V_UI", closeVal);
	
		PTable:set_Item("Robot_DO_Open" .. i .. "_N_UI", openNum);
		PTable:set_Item("Robot_DO_Open" .. i .. "_V_UI", openVal);

	end

    for i = 0, DiCountSelection do
        local doneNum = 0
		local doneVal = 0
        local feedbackSlot = FeedbackDISelection[i]
        if feedbackSlot then
            doneNum = tonumber(feedbackSlot[0].value) or 0
            doneVal = tonumber(feedbackSlot[1].value) or 0
        end

        WaitValue = WaitValue + doneVal * 2 ^ doneNum;
		WaitMask = WaitMask + 1 * 2 ^ doneNum;

		PTable:set_Item("Robot_DI_Done" .. i .. "_N_UI", doneNum);
		PTable:set_Item("Robot_DI_Done" .. i .. "_V_UI", doneVal);
    end

	-- Comment these out eventually
	PTable:set_Item("CloseGripperDoSelection", CloseGripperDoSelection)
	PTable:set_Item("OpenGripperDoSelection", OpenGripperDoSelection)
	PTable:set_Item("FeedbackDiSelection", FeedbackDISelection)

	PTable:set_Item("DoCountSelection", DoCountSelection)
	PTable:set_Item("DiCountSelection", DiCountSelection)
	PTable:set_Item("Robot_Di_Done_Timeout_UI", Robot_DI_Done_Timeout_UI);
	PTable:set_Item("Robot_DetectionDelay_UI", Robot_DetectionDelay_UI);
	PTable:set_Item("NotEqual_UI", NotEqual_UI);
	PTable:set_Item("WaitValue", WaitValue);
	PTable:set_Item("WaitMask", WaitMask);
	PTable:set_Item("WaitStart", WaitStart);
	PTable:set_Item("WaitLenth", WaitLength);
end

local function ToJsonString(jsonStr)
	local index = string.find(jsonStr, ':[^:]*$')
	return string.sub(jsonStr, 1, index-1)
end

-- Verify PTable is setup (using dummy parameter)
PTable:set_Item('Vender', 'Mantis Robotics Inc')
vendor = PTable:get_Item('Vender')
CS.UnityEngine.Debug.Log(vendor)

-- Load All Variables in PTable
for i,d in pairs(Instance.uiPageOnEdit.uiGroups) do
    
	for j,k in pairs(d.uiElements) do
        UiElement=Instance:GetUiElementByName(k.name)   --find UIelement
        UiElementType=UiElement:GetType().Name

		if(UiElement.name ~= nil) then
			ui_name=UiElement.name
		else
			ui_name = "Unkown"
		end
		
		tag_name=UiElementType..'_'..ui_name..'_values'
		
		CS.UnityEngine.Debug.Log('Group Number: '..i.. 
						'\nElement Number: '..j ..
						'\nUiElement Type: '..UiElementType ..
						'\nUiElement Name: '..ui_name ..
						'\nTag Name: ' .. tag_name)
		
		
		-- [Check Box] [Text Display] [Text Input] [Int Input] [Float Input]
        if (UiElementType=='CheckBox') or 
		     (UiElementType=='Text_Display') or 
		       (UiElementType=='Text_Input') or 
		         (UiElementType=='Int_Input') or
				   (UiElementType == "Float_Input") or
				   (UiElementType == "Dropdown") then
			-- Load Values
            if(PTable:ContainsKey(tag_name)) then
                UiElement.value=PTable:get_Item(tag_name)
			end
			
			
		-- [Transform] [Joint] 
		elseif (UiElementType=='Transform') or 
				(UiElementType=='Joint') then
			if(PTable:ContainsKey(tag_name)) then
                load_values=PTable:get_Item(tag_name)
				n=0
                for value in load_values:gmatch('[^,%s]+') do
                    UiElement.value[n]=tonumber(value)
                    n=n+1
                end 
			end


        -- [Project Tool]
        elseif UiElementType=='ProjectTool' then
            if(PTable:ContainsKey(tag_name..'_transform')) then
                -- Load: Transform
				load_values=PTable:get_Item(tag_name..'_transform')  --load value from PTable
                n=0
                for value in load_values:gmatch('[^,%s]+') do
                    UiElement.value.transform[n]=tonumber(value)
                    n=n+1
				end
				
				-- Load: Tool Name
                if PTable:ContainsKey(UiElementType..'_'..k.name..'_values_toolName') then
                    UiElement.value.toolName=PTable:get_Item(tag_name..'_toolName')
                end
				
				-- Load: TCP Number
                if PTable:ContainsKey(UiElementType..'_'..k.name..'_values_tcpNumber') then
                    UiElement.value.tcpNumber=PTable:get_Item(tag_name..'_tcpNumber')
                end
			end
				
		
		-- [Digital_Input] [Digital_Output]
		elseif (UiElementType == 'Digital_Input') or 
			     (UiElementType == 'Digital_Output') then
			if (PTable:ContainsKey(tag_name)) then
                UiElement:SetValueWithJsonString(ToJsonString(tostring(PTable:get_Item(tag_name))))
            end
			
		
		-- [List]		
		elseif (UiElementType == "List") then
			if(PTable:ContainsKey(tag_name)) then

				local temp_values=PTable:get_Item(tag_name)

				if tostring(temp_values):sub(1,1)=="S" or tostring(temp_values):sub(1,1)=="n" then
					UiElement.value=temp_values
				else
					
					UiElement:SetValueWithJsonString(ToJsonString(tostring(temp_values)))
				end
		


                UiElement:SetValueWithJsonString(ToJsonString(tostring(PTable:get_Item(tag_name))))
            end

		-- [SubMenuLink]
		elseif (UiElementType == "SubMenuLink") then
			CS.UnityEngine.Debug.Log("Error Not Yet Implemented: " .. UiElementType)
			
		else
			CS.UnityEngine.Debug.Log("Unknow Type: " .. UiElementType)
			error("Unknow Type: " .. UiElementType)
		end
		
        UiElement:RefreshUI()
    end
end

WriteToPTableForRobotCodeGen();
